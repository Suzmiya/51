C51 COMPILER V9.50a   DS18B20                                                              01/01/2013 00:09:28 PAGE 1   


C51 COMPILER V9.50a, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN .\Obj\ds18b20.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE App\ds18b20\ds18b20.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\App\24c02;.\App\
                    -iic;.\App\key;.\App\smg;.\Public;.\App\ds18b20;.\App\ds1302;.\App\lcd1602;.\App\beep) DEBUG OBJECTEXTEND PRINT(.\Obj\ds1
                    -8b20.lst) TABS(2) OBJECT(.\Obj\ds18b20.obj)

line level    source

   1          #include "ds18b20.h"
   2          #include "intrins.h"
   3          
   4          /*******************************************************************************
   5          * 函 数 名         : ds18b20_reset
   6          * 函数功能       : 复位DS18B20  
   7          * 输    入         : 无
   8          * 输    出         : 无
   9          *******************************************************************************/
  10          void ds18b20_reset(void)
  11          {
  12   1        DS18B20_PORT=0; //拉低DQ
  13   1        delay_10us(75); //拉低750us
  14   1        DS18B20_PORT=1; //DQ=1
  15   1        delay_10us(2);  //20US
  16   1      }
  17          
  18          /*******************************************************************************
  19          * 函 数 名         : ds18b20_check
  20          * 函数功能       : 检测DS18B20是否存在
  21          * 输    入         : 无
  22          * 输    出         : 1:未检测到DS18B20的存在，0:存在
  23          *******************************************************************************/
  24          u8 ds18b20_check(void)
  25          {
  26   1        u8 time_temp=0;
  27   1      
  28   1        while(DS18B20_PORT&&time_temp<20) //等待DQ为低电平
  29   1        {
  30   2          time_temp++;
  31   2          delay_10us(1);  
  32   2        }
  33   1        if(time_temp>=20)return 1;  //如果超时则强制返回1
  34   1        else time_temp=0;
  35   1        while((!DS18B20_PORT)&&time_temp<20)  //等待DQ为高电平
  36   1        {
  37   2          time_temp++;
  38   2          delay_10us(1);
  39   2        }
  40   1        if(time_temp>=20)return 1;  //如果超时则强制返回1
  41   1        return 0;
  42   1      }
  43          
  44          /*******************************************************************************
  45          * 函 数 名         : ds18b20_read_bit
  46          * 函数功能       : 从DS18B20读取一个位
  47          * 输    入         : 无
  48          * 输    出         : 1/0
  49          *******************************************************************************/
  50          u8 ds18b20_read_bit(void)
  51          {
  52   1        u8 dat=0;
  53   1        
C51 COMPILER V9.50a   DS18B20                                                              01/01/2013 00:09:28 PAGE 2   

  54   1        DS18B20_PORT=0;
  55   1        _nop_();_nop_();
  56   1        DS18B20_PORT=1; 
  57   1        _nop_();_nop_(); //该段时间不能过长，必须在15us内读取数据
  58   1        if(DS18B20_PORT)dat=1;  //如果总线上为1则数据dat为1，否则为0
  59   1        else dat=0;
  60   1        delay_10us(5);
  61   1        return dat;
  62   1      } 
  63          
  64          /*******************************************************************************
  65          * 函 数 名         : ds18b20_read_byte
  66          * 函数功能       : 从DS18B20读取一个字节
  67          * 输    入         : 无
  68          * 输    出         : 一个字节数据
  69          *******************************************************************************/
  70          u8 ds18b20_read_byte(void)
  71          {
  72   1        u8 i=0;
  73   1        u8 dat=0;
  74   1        u8 temp=0;
  75   1      
  76   1        for(i=0;i<8;i++)//循环8次，每次读取一位，且先读低位再读高位
  77   1        {
  78   2          temp=ds18b20_read_bit();
  79   2          dat=(temp<<7)|(dat>>1);
  80   2        }
  81   1        return dat; 
  82   1      }
  83          
  84          /*******************************************************************************
  85          * 函 数 名         : ds18b20_write_byte
  86          * 函数功能       : 写一个字节到DS18B20
  87          * 输    入         : dat：要写入的字节
  88          * 输    出         : 无
  89          *******************************************************************************/
  90          void ds18b20_write_byte(u8 dat)
  91          {
  92   1        u8 i=0;
  93   1        u8 temp=0;
  94   1      
  95   1        for(i=0;i<8;i++)//循环8次，每次写一位，且先写低位再写高位
  96   1        {
  97   2          temp=dat&0x01;//选择低位准备写入
  98   2          dat>>=1;//将次高位移到低位
  99   2          if(temp)
 100   2          {
 101   3            DS18B20_PORT=0;
 102   3            _nop_();_nop_();
 103   3            DS18B20_PORT=1; 
 104   3            delay_10us(6);
 105   3          }
 106   2          else
 107   2          {
 108   3            DS18B20_PORT=0;
 109   3            delay_10us(6);
 110   3            DS18B20_PORT=1;
 111   3            _nop_();_nop_();  
 112   3          } 
 113   2        } 
 114   1      }
 115          
C51 COMPILER V9.50a   DS18B20                                                              01/01/2013 00:09:28 PAGE 3   

 116          /*******************************************************************************
 117          * 函 数 名         : ds18b20_start
 118          * 函数功能       : 开始温度转换
 119          * 输    入         : 无
 120          * 输    出         : 无
 121          *******************************************************************************/
 122          void ds18b20_start(void)
 123          {
 124   1        ds18b20_reset();//复位
 125   1        ds18b20_check();//检查DS18B20
 126   1        ds18b20_write_byte(0xcc);//SKIP ROM
 127   1          ds18b20_write_byte(0x44);//转换命令 
 128   1      }
 129          
 130          /*******************************************************************************
 131          * 函 数 名         : ds18b20_init
 132          * 函数功能       : 初始化DS18B20的IO口 DQ 同时检测DS的存在
 133          * 输    入         : 无
 134          * 输    出         : 1:不存在，0:存在
 135          *******************************************************************************/ 
 136          u8 ds18b20_init(void)
 137          {
 138   1        ds18b20_reset();
 139   1        return ds18b20_check(); 
 140   1      }
 141          
 142          /*******************************************************************************
 143          * 函 数 名         : ds18b20_read_temperture
 144          * 函数功能       : 从ds18b20得到温度值
 145          * 输    入         : 无
 146          * 输    出         : 温度数据
 147          *******************************************************************************/
 148          float ds18b20_read_temperture(void)
 149          {
 150   1        float temp;
 151   1        u8 dath=0;
 152   1        u8 datl=0;
 153   1        u16 value=0;
 154   1      
 155   1        ds18b20_start();//开始转换
 156   1        ds18b20_reset();//复位
 157   1        ds18b20_check();
 158   1        ds18b20_write_byte(0xcc);//SKIP ROM
 159   1          ds18b20_write_byte(0xbe);//读存储器
 160   1      
 161   1        datl=ds18b20_read_byte();//低字节
 162   1        dath=ds18b20_read_byte();//高字节
 163   1        value=(dath<<8)+datl;//合并为16位数据
 164   1      
 165   1        if((value&0xf800)==0xf800)//判断符号位，负温度
 166   1        {
 167   2          value=(~value)+1; //数据取反再加1
 168   2          temp=value*(-0.0625);//乘以精度 
 169   2        }
 170   1        else //正温度
 171   1        {
 172   2          temp=value*0.0625;  
 173   2        }
 174   1        return temp;
 175   1      }


C51 COMPILER V9.50a   DS18B20                                                              01/01/2013 00:09:28 PAGE 4   

MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    368    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      14
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
